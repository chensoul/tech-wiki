## Node.js是什么

Node.js是一个JavaScript运行平台，其显著特征是它的异步和事件驱动机制，以及小巧精悍的标准库。Node目前有两个活跃版本：长期支持版（LTS）和当前版，由Node.js基金会进行管理并提供支持。这个行业联盟遵循开放式治理模型。



2009年Node.js问世。



ECMAScript 2015解决了之前那些ECMAScript标准中遗留下来的几个关键问题。Node所用的Google V8引擎就是基于ECMAScript 2015开发的。ECMAScript 2015是ECMAScript标准的第6个版本，所以有时也被称为ES6，一般简写为ES2015。



Node和JavaScript的优势之一是它们的**单线程编程模型**



在为浏览器编写代码时，我们写的指令序列一次执行一条，代码不是并行执行的。然而对于用户界面来说，这样是不合理的：没有哪个用户想在浏览器执行网络访问或文件获取这样的低速操作时干等着。为了解决这个问题，浏览器引入了事件机制：在你点击按钮时，就有一个事件被触发，还有一个之前定义的函数会跑起来。这种机制可以规避一些在线程编程中经常出现的问题，比如资源死锁和竞态条件。



### 非阻塞I/O

我们希望，在读取文件或通过网络发送消息时，运行平台不会阻塞业务逻辑的执行。Node用三种技术来解决这个问题：事件、异步API、非阻塞I/O。

![img](https://res.weread.qq.com/wrepub/epub_26211831_3)

上图展示了一个典型的Node Web应用程序，它用Web应用库Express来处理商店的订单流程。为了购买产品，浏览器发起了一个请求，然后应用程序检查库存，为该用户创建一个账号，发回执邮件，并返回一个JSON HTTP响应给浏览器。同时在做的其他事情有：发送了一封回执邮件，更新了数据库来保存用户的详细信息和订单。代码本身很简单，就是JavaScript指令，但运行平台是并发操作的，因为它用了非阻塞I/O。



上图中数据库是通过网络访问的。Node中的网络访问是非阻塞的，它用了一个名为libuv的库来访问操作系统的非阻塞网络调用。



访问硬盘也差不多，但又不完全一样。在生成了回执邮件并从硬盘中读取邮件模板时，libuv借助线程池模拟出了一种使用非阻塞调用的假象。



### 事件轮询

仔细研究“响应浏览器的请求”那部分。在这个应用程序中，Node内置的HTTP服务器库，即核心模块http.Server，负责用流、事件、Node的HTTP请求解析器的组合来处理请求，它是本地代码。你用Express Web应用库添加的回调函数，也是由它触发的。这个回调函数又会触发数据库查询语句，最终应用程序会用HTTP发送JSON作为响应。整个过程用了三个非阻塞网络调用：一个用于请求，一个用于数据库，还有一个用于响应。Node是如何调配这些网络操作的呢？答案是事件轮询（event loop）。



![img](https://res.weread.qq.com/wrepub/epub_26211831_4)



事件轮询是单向运行的先入先出队列，它要经过几个阶段，首先是计时器开始执行，这些计时器都是用JavaScript函数setTimeout和setInterval安排好的。接下来是运行I/O回调，即触发你的回调函数。轮询阶段会去获取新的I/O事件，最后是用setImmediate安排回调。

## ES2015、Node和V8

从Node 6开始，你可以用默认函数参数、剩余参数、spread操作符、for...of循环、模板字符串、解构、生成器等很多新特性。http://node.green 上汇总了Node支持的ES2015特性。

- Node 6和ES2015，支持 class
- Node 4开始，const和let（代替了var）解决了作用域的问题
- Node还有原生的promise和生成器，生成器能把异步I/O变成同步编程风格
- ES2015中的模板字符串在Node中也很好用。在ES5中，字符串常量不支持插值，也不能跨行。现在我们可以用反引号（`）定义模板字符串，不仅可以插值，而且还可以跨行。
- Node支持箭头函数

### Node 和 V8

Node的动力源自V8 JavaScript引擎，是由服务于Google Chrome的Chromium项目组开发的。V8的一个值得称道的特性是它会被JavaScript直接编译为机器码，另外它还有一些代码优化特性，所以Node才能这么快。在1.1.1节，我们曾提到过Node的另一个本地部件libuv，它是负责处理I/O的。V8负责JavaScript代码的解释和执行。用C++绑定层可将libuv和V8结合起来。

![img](https://res.weread.qq.com/wrepub/epub_26211831_5)

### 使用特性组

Node包含了V8提供的ES2015特性。这些特性分为shipping、staged和in progress三组。shipping组的特性是默认开启的，staged和in progress组的特性则需要用命令行参数开启。如果你想用staged特性，可以在运行Node时加上参数--harmony, V8团队将所有接近完成的特性都放在了这一组。然而，in progress特性稳定性较差，需要具体的特性参数来开启。Node的文档建议通过grep "in progress"来查询当前可用的in progress特性：

```bash
node --v8-options|grep "in progress"
```

### 了解Node的发布计划

Node的发行版分为长期支持版（LTS）、当前版和每日构建版三组。LTS版有18个月的支持服务，期满后还有12个月的维护性支持服务。版本号是按照语义版本（SemVer）编制的。SemVer给每个版本定义了一个主要、次要和补丁版本号。比如6.9.1的主要版本号是6，次要版本号是9，补丁版本号是1。只要看到主版本号发生变化，那就意味着有些API可能不兼容了，也就是说如果要用这个版本的Node，那么你的项目需要重新测试一下。



另外，按Node的发布规则，主版本号增长意味着新的当前版也已经切下来了。每日构建版的构建是自动进行的，每隔24小时一次，包含这24小时内的最新修改，但一般只用来测试Node的最新特性。